---
author_association: OWNER
created_at: '2022-08-21T11:50:38Z'
html_url: https://github.com/IkumaTadokoro/diary/issues/69#issuecomment-1221530113
id: 1221530113
issue_url: https://api.github.com/repos/IkumaTadokoro/diary/issues/69
node_id: IC_kwDOHWTPVs5IzxIB
performed_via_github_app: 
reactions:
  "+1": 0
  "-1": 0
  confused: 0
  eyes: 0
  heart: 0
  hooray: 0
  laugh: 0
  rocket: 0
  total_count: 0
  url: https://api.github.com/repos/IkumaTadokoro/diary/issues/comments/1221530113/reactions
updated_at: '2022-08-21T11:50:38Z'
url: https://api.github.com/repos/IkumaTadokoro/diary/issues/comments/1221530113
user:
  avatar_url: https://avatars.githubusercontent.com/u/61409641?v=4
  events_url: https://api.github.com/users/IkumaTadokoro/events{/privacy}
  followers_url: https://api.github.com/users/IkumaTadokoro/followers
  following_url: https://api.github.com/users/IkumaTadokoro/following{/other_user}
  gists_url: https://api.github.com/users/IkumaTadokoro/gists{/gist_id}
  gravatar_id: ''
  html_url: https://github.com/IkumaTadokoro
  id: 61409641
  login: IkumaTadokoro
  node_id: MDQ6VXNlcjYxNDA5NjQx
  organizations_url: https://api.github.com/users/IkumaTadokoro/orgs
  received_events_url: https://api.github.com/users/IkumaTadokoro/received_events
  repos_url: https://api.github.com/users/IkumaTadokoro/repos
  site_admin: false
  starred_url: https://api.github.com/users/IkumaTadokoro/starred{/owner}{/repo}
  subscriptions_url: https://api.github.com/users/IkumaTadokoro/subscriptions
  type: User
  url: https://api.github.com/users/IkumaTadokoro

---
一旦調査に時間がかかりすぎる部分は置いておいて、残りをみてみることにする。

また`main.run`に戻って来た。

`loadProtoDefs`を用いて、PDLの情報を`protoDefs`に代入する。

`sort.Slice`: これは標準っぽい。

https://qiita.com/Sekky0905/items/2d5ccd6d076106e9d21c

- ソートには安定ソートという概念がある。
- sort packageのSliceは安定ソートを保証せず、SliceStableは安定ソートを保する

第2引数に関数を渡しているけど、一般的にいえばこの関数で比較してソートしてそう。

```go
sort.Slice(protoDefs.Domains, func(i, j int) bool {
return strings.Compare(protoDefs.Domains[i].Domain.String(), protoDefs.Domains[j].Domain.String()) <= 0
})
```

で、この後にフォルダを作成して、どんどん書き込んでいく。

```go
if d.Deprecated {
	var extra []string
	extra = append(extra, "deprecated")
	util.Logf("SKIPPING(%s): %s %v", pad("domain", 7), d.Domain.String(), extra)
	continue
}
```

で、どうもDeprecatedなものがあれば、スキップされているみたい。

このあとREADMEにもあった、`fixup`処理をやっているんだけど、これはなに？

```go
// fixup
fixup.FixDomains(processed)
```

pdlgen/fixup/fixup.goに飛んだ。コメントには何が書いてある？

```go
// FixDomains modifies, updates, alters, fixes, and adds to the types defined
// in the domains, so that the generated Chrome DevTools Protocol domain code
// is more Go-like and easier to use.
//
// Please see package-level documentation for the list of changes made to the
// various domains.
func FixDomains(domains []*pdl.Domain) {
```

ってことで、Packageのドキュメントをみてみる。

```go
// Package fixup modifies/alters/fixes and adds to the low level type
// definitions for the Chrome DevTools Protocol domains, as generated from
// protocol.json.
//
// The goal of package fixup is to fix the issues associated with generating Go
// code from the existing Chrome domain definitions, and is wrapped up in one
// high-level func, FixDomains.
//
// Currently, FixDomains does the following:
//  - add `Inspector.DetachReason` type and change `Inspector.detached.reason`
//    type to `Inspector.DetachReason`.
//  - change `Network.TimeSinceEpoch`, `Network.MonotonicTime`, and
//    `Runtime.Timestamp` types to `TimestampTypeSecond` and
//    `TimestampTypeMonotonic`.
//  - convert all object properties and event/command parameters that are enums
//    into separate types.
//  - change any object property named `modifiers` to type `Input.Modifier`.
//  - add `DOM.NodeType` type and set any parameter named `nodeType`'s type to
//    `DOM.NodeType`.
//  - change `Page.Frame.{id,parentID}` property named `modifiers` to type `Input.Modifier`.
//  - add `DOM.NodeType` type and set any parameter named `nodeType`'s type to
//    `DOM.NodeType`.
//  - change `Page.Frame.{id,parentID}` properties to `FrameID` type.
//  - add additional properties to `Page.Frame` and `DOM.Node` for use by
//    higher level packages.
//  - add special unmarshaler to `Page.{NodeId,BackendNodeId,FrameId}` types to
//    handle unquoted values from older (v1.1) protocol versions. NOTE: it may
//    be necessary in the future to apply this to more types, such as
//    `Network.LoaderId`.
//  - rename `Input.GestureSourceType` to `Input.GestureType`.
//  - fix type/name stuttering by stripping the package name from any type
//    where the package name is a prefix (ie, `CSS` domain).
//  - add Error() method to `Runtime.ExceptionDetails` so that it can be used
//    as error.
//  - change `Network.Headers` type to map[string]interface{}.
//
// Please note that the above is not an exhaustive list of all modifications
// applied to the domains, however it does attempt 
```

細かいことは「Currently, ...」以下にまとめられているけど、CDPのプロトコルから、GoLikeな感じでコードを生成するために必要な情報を付与している。
あと備忘として、ここにある情報だけがやっていることの全てではないことに注意。

これRubyでやるときにどうするかなあ。RBSでやってもいいけど、実装時間が足りないかんじするよな。

